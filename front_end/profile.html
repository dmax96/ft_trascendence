<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <title>PONG-profile</title>
  </head>
  <style>
    /* Stile base per dispositivi con schermo di larghezza inferiore a 600px */
    body {
      background-color: #dfa100;
    }

    /* Stile per dispositivi con schermo di larghezza compresa tra 600px e 900px */
    @media screen and (min-width: 600px) {
      body {
        background-color: #dfa100;
      }
      .div-title {
        font-family: "font-Despairs";
        font-size: 400%;
        position: absolute;
        left: 42%;
        right: 2%;
        top: 3%;
        padding: 1%;
        color: black;
      }
      .img-fluid {
        width:20%;
        height:20%;
        position: relative;
        top: 20%;
        left: 2%;
      }
      .image {
        width: 700px;
        height: 500px;
      }
      .nickname {
        font-family: "";
        font-size: 200%;
        position: absolute;
        top: 140%;
        left: 35%;
      }
      .statistics {
        width: 30%;
        height: 30%;
        position: absolute;
        left: 60%;
      }
    }

    /* Stile per dispositivi con schermo di larghezza superiore a 900px */
    @media screen and (min-width: 900px) {
      body {
        background-color: #dfa100;
      }
      .div-title {
        font-family: "font-Despairs";
        font-size: 400%;
        position: absolute;
        left: 42%;
        right: 2%;
        top: 3%;
        padding: 1%;
        color: black;
      }
      .profile {
        display: flex;
        position: relative;
        top: 200px;
      }
      .img-fluid {
        width: 50%;
        height: 50%;
        position: relative;
        top: 200px;
        left: 2%;
        min-height: 800px;
      }
      .image {
        width: 100%;
        height: 100%;
      }
      .nickname {
        font-family: "";
        font-size: 240%;
        position: relative;
        left: 40%;
        top: 5%;
        display: flex;
      }
      .game_title {
        font-family: "";
        font-size: 300%;
        position: relative;
        left: 42%;
        margin-bottom: 8%;
      }
      .statistics {
        height: 50%;
        width: 30%;
      }
      .data {
        font-size: 200%;
      }
      .history {
        font-size: 200%;
      }
      .pong {
        margin-bottom: 10%;
      }
      .tris {
        margin-top: 9%;
      }
      .nick {
        font-size: 143%;
        position: relative;
      }
      .modify {
        position: relative;
        left: 44%;
        cursor: pointer;
      }
      .image-container {
        position: relative;
        width: 40%; /* Adatta a seconda delle tue esigenze */
        height: 50%; /* Adatta a seconda delle tue esigenze */
        min-height: 1px;
      }

      .image-container img {
        max-width: 1000px;
        max-height: 1000px;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .edit-icon {
        position: absolute;
        bottom: 10px;
        right: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        font-size: 24px;
        cursor: pointer;
      }
	  .modal {
		display: none;
		position: fixed;
		z-index: 1;
		padding-top: 100px;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		overflow: auto;
		background-color: rgb(0,0,0);
		background-color: rgba(0,0,0,0.4);
		}

		.modal-content {
		background-color: #f4dc9e;
		margin: auto;
		padding: 20px;
		border: 1px solid #888;
		width: 50%;
		height: 40%;
		}

		.close {
		color: #aaaaaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
		}

		.close:hover,
		.close:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
		}

		.image-preview img {
		width: 200px; /* Increase the width */
		height: 200px; /* Increase the height */
		margin: 5px;
		cursor: pointer; 
	}
    }
  </style>
  <body>
    <div>
    <h2 id = "go_to_main" class="div-title">PONG</h2>
    <div>
    <div class="profile">
      <div class="img-fluid">
        <div class="image-container">
          <img id="profile-image" src="" alt="Your Image" />
          <i id="edit-icon" class="fas fa-edit edit-icon"></i>
        </div>
        <div class="nickname">
          <div>
            <h2 id="player">Mvolpi</h2>
          </div>
          <div class="modify">
            <i id="modify-icon" class="fas fa-edit modify"></i>
          </div>
        </div>
      </div>
	  <div id="myModal" class="modal">
		<div class="modal-content">
		  <span class="close">&times;</span>
		  <div class="image-preview">
			<!-- Images will be added here by JavaScript -->
		  </div>
		</div>
	  </div>
      <div class="statistics">
        <div class="pong">
          <h2 class="game_title">Pong</h2>
          <h6 class="history">
          </h6>
          <h6 class="history">
          </h6>
          <h6 class="history">
          </h6>
          <h6 class="history">
          </h6>
          <h6 class="history">
          </h6>
		  <h6 class="data wins">Wins: </h6>
		  <h6 class="data losses">Losses: </h6>
		  <h6 class="data winratePong">	Winrate: </h6>
        </div>
        <hr />
        <div class="tris">
          <h2 class="game_title">Tris</h2>
          <h6 class="history">
          </h6>
          <h6 class="history">
          </h6>
          <h6 class="history">
	      </h6>
          <h6 class="history">
          </h6>
          <h6 class="history">
          </h6>
		  <h6 class="data wins">Wins: </h6>
		  <h6 class="data losses">Losses: </h6>
      <h6 class="data ties">Ties:</h6>
		  <h6 class="data winrateTris">	Winrate: </h6>
        </div>
      </div>
    </div>
    </div>
    </div>
  </body>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
	var modal = document.getElementById("myModal");
	var span = document.getElementsByClassName("close")[0];

	span.onclick = function() {
		modal.style.display = "none";
	}

	window.onclick = function(event) {
	if (event.target == modal) {
		modal.style.display = "none";
	}
	}

	var imagePreview = document.querySelector('.image-preview');
	var imagePaths = ['Mattarella.jpg', 'mikeTyson.png', 'carletto.jpg', 'richard.jpg', 'lebowski.png', 'Jacobs.png', 'gricia.jpg', 'ai.jpg', 'silvietto.jpeg', 'blade_runner.jpeg'];

	imagePaths.forEach(function(path) {
		var img = document.createElement('img');
		img.src = 'media/' + path;
		img.style.flex = "0 1 calc(20% - 10px)"; // This will make the image take up 20% of the container width minus 10px for margins
		//Call to the back-end to update user  data.
		img.onclick = function() {
		document.getElementById('profile-image').src = this.src;
		modal.style.display = "none";
		var token = localStorage.getItem('userToken');
		// Remove the base URL from the image src
		var imagePath = this.src.replace('http://127.0.0.1:5501/front_end/', '');
		// Send a fetch request to the backend
		fetch('http://localhost:8001/main/profile_image/', {
			method: 'POST',
			headers: {
				'Authorization' : 'Token ' + token,
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				profile_path: imagePath // Send the new image path to the backend
			}),
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
		})
		.catch((error) => {
			console.error('Error:', error);
		});
		}
		imagePreview.appendChild(img);
	});

  function loadMatchHistory(){
    var pongHistory = window.parent.userInstance.matchistory_pong;
		var trisHistory = window.parent.userInstance.matchistory_tictactoe;

		// Get all the h6 elements with class 'history' under 'pong' and 'tris'
		var pongHistoryElements = document.querySelectorAll('.pong .history');
		var trisHistoryElements = document.querySelectorAll('.tris .history');

    var startPongIndex = pongHistory.length > 5 ? pongHistory.length - 5 : 0;
    for (var i = startPongIndex, j = 0; i < pongHistory.length; i++, j++) {
        var match = pongHistory[i];
        var result;
        if (match.win === "true") {
            result = 'W';
        } else if (match.win === "false"){
            result = 'L';
        }
        var date = match.date.slice(0, -1); // This will remove the last character from match.date
        pongHistoryElements[j].textContent = `${date}  vs ${match.player2} : ${result} (${match.score} - ${match.scoreplayer2})`;
    }

    var startTrisIndex = trisHistory.length > 5 ? trisHistory.length - 5 : 0;
    for (var i = startTrisIndex, j = 0; i < trisHistory.length; i++, j++) {
        var match = trisHistory[i];
        var result;
        if (match.win === "win") {
            result = 'W';
        } else if (match.win === "lose"){
            result = 'L';
        } else if (match.win === "draw"){
            result = 'T';
        }
        trisHistoryElements[j].textContent = `${match.date}  vs ${match.player2} : ${result}`;
    }
        // Add the number of matches won and lost for Pong
        var pongWins = document.querySelector('.pong .data.wins');
        var pongLosses = document.querySelector('.pong .data.losses');
		    var pongWinrate = document.querySelector('.pong .data.winratePong');
        pongWins.textContent = 'W: ' + window.parent.userInstance.wins_pong;
        pongLosses.textContent = 'L: ' + window.parent.userInstance.loses_pong;
        var winrate = parseFloat(window.parent.userInstance.winrate_pong).toFixed(2);
		    pongWinrate.textContent = 'Winrate: ' + winrate + '%';

        // Add the number of matches won and lost for Tris
        var trisWins = document.querySelector('.tris .data.wins');
        var trisLosses = document.querySelector('.tris .data.losses');
        var trisTies = document.querySelector('.tris .data.ties');
	    	var trisWinrate = document.querySelector('.tris .data.winrateTris');
        trisWins.textContent = 'W: ' + window.parent.userInstance.wins_tictactoe;
        trisLosses.textContent = 'L: ' + window.parent.userInstance.loses_tictactoe;
        trisTies.textContent = 'T: ' + (trisHistory.length - window.parent.userInstance.wins_tictactoe - window.parent.userInstance.loses_tictactoe);
        var winrateTris = parseFloat(window.parent.userInstance.winrate_tictactoe).toFixed(2);
        trisWinrate.textContent = 'Winrate: ' + winrateTris + '%';
  }
	if (window.parent.userInstance && window.parent.userInstance.username) {
		document.getElementById("player").innerText  = window.parent.userInstance.player;
    document.getElementById("profile-image").src = window.parent.userInstance.profile_image;
		console.log ("user image: " + window.parent.userInstance.profile_image);
		console.log ("User : " + window.parent.username);
		loadMatchHistory();
	}
	window.addEventListener('message', function(event) {
		// Check the type of the message
		if (event.data.type === 'loadProfile') {
			document.getElementById("player").innerText  = window.parent.userInstance.player;
			document.getElementById("profile-image").src = window.parent.userInstance.profile_image;
			console.log ("user image: " + window.parent.userInstance.profile_image);
			console.log ("User : " + window.parent.userInstance.username);
      loadMatchHistory();
  }
	});

    document.getElementById("edit-icon").addEventListener("click", function () {
		modal.style.display = "block";
    });

	document.getElementById("go_to_main").addEventListener("click", function() {
			localStorage.setItem('lastPage', "main-page");
            window.parent.goToMain();
        });

    document
      .getElementById("modify-icon")
      .addEventListener("click", function () {
        var newNickname = prompt("Inserisci il nuovo nickname:");
        if (newNickname && newNickname.length < 16 ) {
          var nicknameData = {
            player: newNickname,
          };
		  window.parent.userInstance.player = newNickname;
          document.getElementById("player").textContent = newNickname;
          fetch("http://localhost:8001/main/nick/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Token " + localStorage.getItem("userToken"),
            },
            body: JSON.stringify(nicknameData),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Success:", data);
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      });
  </script>
</html>