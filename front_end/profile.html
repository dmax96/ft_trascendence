<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>PONG-profile</title>
  <style>
    /* Stile base per dispositivi con schermo di larghezza inferiore a 600px */
    body {
      background-color: #dfa100;
    }
      
      /* Rimuovo la barra nera in alto */
      .navbar {
        background-color: transparent !important;
        box-shadow: none !important;
        border: none !important;
      }
      
      #hamburger {
        font-size: 24px;
        cursor: pointer;
        color: #333;
        margin: 15px;
    }

    /* Stile per dispositivi con schermo di larghezza compresa tra 600px e 900px */
    @media screen and (min-width: 600px) {
      body {
        background-color: #dfa100;
      }
      .div-title {
        font-family: "font-Despairs";
        font-size: 400%;
        position: absolute;
        left: 42%;
        right: 2%;
        top: 3%;
        padding: 1%;
        color: black;
      }
      .img-fluid {
        width:20%;
        height:20%;
        position: relative;
        top: 20%;
        left: 2%;
      }
      .image {
        width: 700px;
        height: 500px;
      }
      .nickname {
        font-family: "";
        font-size: 200%;
        position: absolute;
        top: 140%;
        left: 35%;
      }
      .statistics {
        width: 30%;
        height: 30%;
        position: absolute;
        left: 60%;
      }
    }

    /* Stile per dispositivi con schermo di larghezza superiore a 900px */
    @media screen and (min-width: 900px) {
      body {
        background-color: #dfa100;
      }
      .div-title {
        font-family: "font-Despairs";
        font-size: 400%;
        position: absolute;
        left: 42%;
        right: 2%;
        top: 3%;
        padding: 1%;
        color: black;
      }
      .profile {
        display: flex;
        position: relative;
        top: 200px;
      }
      .img-fluid {
        width: 50%;
        height: 50%;
        position: relative;
        top: 200px;
        left: 2%;
        min-height: 800px;
      }
      .image {
        width: 100%;
        height: 100%;
      }
      .nickname {
        font-family: "";
        font-size: 240%;
        position: relative;
        left: 40%;
        top: 5%;
        display: flex;
      }
      .game_title {
        font-family: "";
        font-size: 300%;
        position: relative;
        left: 42%;
        margin-bottom: 8%;
      }
      .statistics {
        height: 50%;
        width: 30%;
      }
      .data {
        font-size: 200%;
      }
      .history {
        font-size: 200%;
      }
      .pong {
        margin-bottom: 10%;
      }
      .tris {
        margin-top: 9%;
      }
      .nick {
        font-size: 143%;
        position: relative;
      }
      .modify {
        position: relative;
        left: 44%;
        cursor: pointer;
      }
      .image-container {
        position: relative;
        width: 40%; /* Adatta a seconda delle tue esigenze */
        height: 50%; /* Adatta a seconda delle tue esigenze */
        min-height: 1px;
      }

      .image-container img {
        max-width: 1000px;
        max-height: 1000px;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .edit-icon {
        position: absolute;
        bottom: 10px;
        right: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        font-size: 24px;
        cursor: pointer;
      }
	  .modal {
		display: none;
		position: fixed;
		z-index: 1;
		padding-top: 100px;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		overflow: auto;
		background-color: rgb(0,0,0);
		background-color: rgba(0,0,0,0.4);
		}

		.modal-content {
		background-color: #f4dc9e;
		margin: auto;
		padding: 20px;
		border: 1px solid #888;
		width: 50%;
		height: 40%;
		}

		.close {
		color: #aaaaaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
		}

		.close:hover,
		.close:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
		}

		.image-preview img {
		width: 200px; /* Increase the width */
		height: 200px; /* Increase the height */
		margin: 5px;
		cursor: pointer; 
	}
    }

      #profilePictureOptions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      #profilePictureOptions img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: var(--transition);
      }
      
      #profilePictureOptions img:hover {
        transform: scale(1.1);
        border-color: var(--accent-color);
      }
      
      .selected-image {
        border-color: var(--highlight-color) !important;
    }

    /* Stile per il titolo Profile */
    #title-profile {
      transition: color 0.3s ease;
    }

    #title-profile:hover {
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000;
    }
  </style>
  </head>
  <body>
    <div class="navbar">
      <!-- Rimuovo l'icona hamburger -->
    </div>
    <div class="nav">
      <div class="nav-links">
        <a href="#" id="go_to_main" class="nav-link">
          <span>Home</span>
          <i class="fa-solid fa-house float-end mt-1"></i>
        </a>
        <a href="#" id="go_to_profile" class="active nav-link">
          <span>Profile</span>
          <i class="fa-solid fa-user float-end mt-1"></i>
        </a>
        <a href="#" id="go_to_login" class="nav-link">
          <span>Logout</span>
          <i class="fa-solid fa-right-from-bracket float-end mt-1"></i>
        </a>
      </div>
    </div>
    
    <div class="container mt-5 pt-5">
      <div class="text-center">
        <a href="#" id="title_to_main" style="text-decoration: none; cursor: pointer; display: inline-block;">
          <h1 class="title-main mb-4" id="title-profile" style="cursor: pointer; display: inline-block; margin: 0;">Profile</h1>
        </a>
      </div>
      
      <div class="row mt-5">
        <div class="col-md-5">
          <div class="card profile-card text-center">
            <div class="mb-4">
              <img id="profilePicture" class="avatar mx-auto d-block" style="width: 150px; height: 150px;" src="media/1.jpg" alt="Profile Picture">
            </div>
            <h2 id="nickname" class="mb-3">Username</h2>
            
            <div class="d-grid gap-2 mt-4">
              <button id="changePicture" class="btn btn-primary">Change Profile Picture</button>
            </div>
          </div>
        </div>
        
        <div class="col-md-7">
          <div class="card mb-4">
            <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Statistiche PONG</h3>
            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Vittorie</h5>
                    <h3 id="pong-wins" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Sconfitte</h5>
                    <h3 id="pong-losses" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Percentuale Vittorie</h5>
                    <h3 id="pong-winrate" class="mb-0">0%</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Partite Totali</h5>
                    <h3 id="pong-total" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mb-4">
            <h3 class="mb-4"><i class="fas fa-gamepad me-2"></i>Statistiche Tris</h3>
            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Vittorie</h5>
                    <h3 id="tris-wins" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Sconfitte</h5>
                    <h3 id="tris-losses" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Pareggi</h5>
                    <h3 id="tris-ties" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Percentuale Vittorie</h5>
                    <h3 id="tris-winrate" class="mb-0">0%</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-4">
            <h3 class="mb-4"><i class="fas fa-history me-2"></i>Partite Recenti</h3>
            <div class="card mb-3">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">PONG</h5>
              </div>
              <div id="pong-history" class="list-group list-group-flush">
                <!-- Pong match history will be populated here -->
              </div>
            </div>
            
            <div class="card">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">Tris</h5>
              </div>
              <div id="tris-history" class="list-group list-group-flush">
                <!-- Tris match history will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Change Profile Picture Modal -->
    <div id="pictureModal" class="modal-content" style="display: none;">
		  <span class="close">&times;</span>
      <h3 class="mb-3">Change Profile Picture</h3>
      <div class="row mb-3" id="profilePictureOptions">
        <!-- Profile pictures will be dynamically added here -->
		  </div>
      <button id="confirmPicture" class="btn btn-primary w-100 mt-2">Confirm Selection</button>
		</div>
    
    <!-- Edit Bio Modal -->
    <div id="bioModal" class="modal-content" style="display: none;">
      <span class="close">&times;</span>
      <h3 class="mb-3">Edit Bio</h3>
      <div class="form-group">
        <textarea id="bioText" class="form-control" rows="4" placeholder="Enter your bio (max 150 characters)"></textarea>
        <button id="confirmBio" class="btn btn-primary w-100 mt-2">Save Bio</button>
      </div>
    </div>
    
    <!-- Modal for adding friends -->
    <div id="myModal" class="modal-content rounded" style="display: none; width: 350px; padding: 25px;">
      <span class="close">&times;</span>
      <h3 class="mb-3">Add a friend</h3>
      <div style="width: 100%;">
        <input type="text" id="friendUsername" class="form-control mb-3" placeholder="Enter friend's username" style="width: 100%; display: block; margin-bottom: 15px;">
        <button id="confirmButton" class="btn btn-primary" style="width: 100%; display: block;">Confirm</button>
    </div>
    </div>
    
    <!-- Bootstrap and jQuery JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- JavaScript -->
  <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("go_to_main").addEventListener("click", function() {
          localStorage.setItem('lastPage', "main-page");
          window.parent.goToMain();
        });
        
        document.getElementById("go_to_profile").addEventListener("click", function() {
          localStorage.setItem('lastPage', "main-page");
          window.parent.goToMain();
        });
        
        document.getElementById("title_to_main").addEventListener("click", function() {
          localStorage.setItem('lastPage', "main-page");
          window.parent.goToMain();
        });
        
        document.getElementById("go_to_login").addEventListener("click", function() {
          window.parent.userInstance.resetData();
          token = localStorage.getItem('userToken');
          fetch('http://localhost:8001/login/logout/', {
            method: 'POST',
            headers: {
              'Authorization' : 'Token ' + token,
              'Content-Type': 'application/json'
            },
          }).then(response => {
            if (response.ok) {
              console.log('Logout sent successfully');
            } else {
              console.error('Error sending language change:', response.statusText);
            }
          }).catch(error => {
            console.error('Network error:', error);
          });
          localStorage.setItem('lastPage', "login");
          localStorage.setItem('userToken', '');
          window.parent.goToLogin();
        });
        
        const pictureModal = document.getElementById("pictureModal");
        const bioModal = document.getElementById("bioModal");
        const closeButtons = document.querySelectorAll(".close");
        
        document.getElementById("changePicture").addEventListener("click", function() {
          // Aggiungo tutte le immagini presenti nella cartella media
          const imagePaths = [
            'silvietto.jpeg', 
            'richard.jpg', 
            'mikeTyson.png', 
            'lebowski.png', 
            'carletto.jpg', 
            'blade_runner.jpeg', 
            'ai.jpg', 
            'Mattarella.jpg', 
            'Jacobs.png'
          ];
          const profilePictureOptions = document.getElementById("profilePictureOptions");
          profilePictureOptions.innerHTML = '';

	imagePaths.forEach(function(path) {
            const img = document.createElement('img');
		img.src = 'media/' + path;
            img.alt = path;
            img.className = 'col-3 mb-2';
		img.onclick = function() {
              document.querySelectorAll('#profilePictureOptions img').forEach(img => {
                img.classList.remove('selected-image');
              });
              this.classList.add('selected-image');
            };
            profilePictureOptions.appendChild(img);
          });
          
          pictureModal.style.display = "block";
        });
        
        document.getElementById("confirmPicture").addEventListener("click", function() {
          const selectedImage = document.querySelector('#profilePictureOptions img.selected-image');
          if (selectedImage) {
            document.getElementById('profilePicture').src = selectedImage.src;
            pictureModal.style.display = "none";
            
            const token = localStorage.getItem('userToken');
            const imagePath = selectedImage.src.replace(window.location.origin + '/', '');
            
		fetch('http://localhost:8001/main/profile_image/', {
			method: 'POST',
			headers: {
                'Authorization': 'Token ' + token,
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
                profile_path: imagePath
			}),
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
		})
		.catch((error) => {
			console.error('Error:', error);
		});
		}
        });
        
        closeButtons.forEach(function(button) {
          button.addEventListener("click", function() {
            pictureModal.style.display = "none";
            bioModal.style.display = "none";
          });
        });
        
        window.onclick = function(event) {
          if (event.target == pictureModal || event.target == bioModal) {
            pictureModal.style.display = "none";
            bioModal.style.display = "none";
          }
        };
        
        if (window.parent.userInstance && window.parent.userInstance.username) {
          document.getElementById("nickname").innerText = window.parent.userInstance.player;
          document.getElementById("profilePicture").src = window.parent.userInstance.profile_image;
          
          updateStatistics();
        }
        
        function updateStatistics() {
          console.log('Aggiornamento statistiche...');
          console.log('Istanza utente:', window.parent.userInstance);
          
          // Riferimenti agli elementi DOM per PONG
          const pongWins = document.getElementById("pong-wins");
          const pongLosses = document.getElementById("pong-losses");
          const pongWinrate = document.getElementById("pong-winrate");
          const pongTotal = document.getElementById("pong-total");
          
          // Riferimenti agli elementi DOM per Tris
          const trisWins = document.getElementById("tris-wins");
          const trisLosses = document.getElementById("tris-losses");
          const trisTies = document.getElementById("tris-ties");
          const trisWinrate = document.getElementById("tris-winrate");
          
          // Calcolo statistiche PONG
          const pongWinsValue = parseInt(window.parent.userInstance.wins_pong || 0);
          const pongLossesValue = parseInt(window.parent.userInstance.loses_pong || 0);
          const pongTotalValue = pongWinsValue + pongLossesValue;
          const pongWinrateValue = pongTotalValue > 0 ? Math.round((pongWinsValue / pongTotalValue) * 100) : 0;
          
          // Calcolo statistiche Tris
          const trisWinsValue = parseInt(window.parent.userInstance.wins_tictactoe || 0);
          const trisLossesValue = parseInt(window.parent.userInstance.loses_tictactoe || 0);
          const trisTiesValue = parseInt(window.parent.userInstance.draw_tictactoe || 0);
          const trisTotalValue = trisWinsValue + trisLossesValue + trisTiesValue;
          const trisWinrateValue = (trisWinsValue + trisLossesValue) > 0 ? 
                                    Math.round((trisWinsValue / (trisWinsValue + trisLossesValue)) * 100) : 0;
          
          // Aggiornamento dei valori PONG nell'interfaccia
          pongWins.innerText = pongWinsValue;
          pongLosses.innerText = pongLossesValue;
          pongWinrate.innerText = pongWinrateValue + "%";
          pongTotal.innerText = pongTotalValue;
          
          // Aggiornamento dei valori Tris nell'interfaccia
          trisWins.innerText = trisWinsValue;
          trisLosses.innerText = trisLossesValue;
          trisTies.innerText = trisTiesValue;
          trisWinrate.innerText = trisWinrateValue + "%";
          
          // Debug per verificare i valori
          console.log('Tris Ties:', trisTiesValue);
          console.log('Tris Wins:', trisWinsValue);
          console.log('Tris Losses:', trisLossesValue);
          
          // Ottieni riferimenti ai contenitori delle cronologie
          const pongHistoryContainer = document.getElementById("pong-history");
          const trisHistoryContainer = document.getElementById("tris-history");
          
          // Pulisci i contenitori
          pongHistoryContainer.innerHTML = "";
          trisHistoryContainer.innerHTML = "";
          
          // Ottieni le cronologie delle partite
          const pongHistory = window.parent.userInstance.matchistory_pong || [];
          const trisHistory = window.parent.userInstance.matchistory_tictactoe || [];
          
          console.log('Cronologia Pong:', pongHistory);
          console.log('Cronologia Tris:', trisHistory);
          
          // Funzione per convertire la data in un oggetto Date per il confronto
          function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            if (dateStr.match(/^\d{1,2}\/\d{1,2}$/)) {
              const currentYear = new Date().getFullYear();
              dateStr = dateStr + '/' + currentYear;
            }
            const parts = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
            if (parts.length >= 3) {
              const [day, month, year] = parts.map(Number);
              return new Date(year, month - 1, day);
            }
            return new Date(dateStr);
          }
          
          // Ordina le partite PONG per data (più recenti prima)
          const sortedPongHistory = [...pongHistory].sort((a, b) => {
            const dateA = parseDate(a.date);
            const dateB = parseDate(b.date);
            return dateB - dateA;
          });
          
          // Ordina le partite Tris per data (più recenti prima)
          const sortedTrisHistory = [...trisHistory].sort((a, b) => {
            const dateA = parseDate(a.date);
            const dateB = parseDate(b.date);
            return dateB - dateA;
          });
          
          // Prendi solo le ultime 5 partite di ogni tipo
          const recentPongMatches = sortedPongHistory.slice(0, 5);
          const recentTrisMatches = sortedTrisHistory.slice(0, 5);
          
          // Funzione per formattare la data
          function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
              const dateObj = parseDate(dateStr);
              if (!isNaN(dateObj.getTime())) {
                return dateObj.toLocaleDateString('it-IT', { 
                  day: '2-digit', 
                  month: '2-digit', 
                  year: 'numeric' 
                });
              }
              return dateStr;
            } catch (e) {
              console.log("Errore nel parsing della data:", e);
              return dateStr;
            }
          }
          
          // Popola la cronologia PONG
          recentPongMatches.forEach(match => {
            // Gestione risultato
            let isWin = match.win === "true" || match.win === "win";
            
            const matchItem = document.createElement("div");
            matchItem.className = "list-group-item d-flex justify-content-between align-items-center";
            
            let resultText = isWin ? 'Vittoria' : 'Sconfitta';
            let dateDisplay = formatDate(match.date);
            
            matchItem.innerHTML = `
              <div>
                <strong>${dateDisplay}</strong> vs ${match.player2}
              </div>
              <div>
                <span class="badge ${isWin ? 'bg-success' : 'bg-danger'} rounded-pill">
                  ${resultText} (${match.score} - ${match.scoreplayer2})
                </span>
              </div>
            `;
            
            pongHistoryContainer.appendChild(matchItem);
          });
          
          // Popola la cronologia Tris
          recentTrisMatches.forEach(match => {
            // Gestione risultato
            let resultText, resultClass;
            
            if (match.win === "draw") {
              resultText = 'Pareggio';
              resultClass = 'bg-warning';
            } else if (match.win === "true" || match.win === "win") {
              resultText = 'Vittoria';
              resultClass = 'bg-success';
            } else {
              resultText = 'Sconfitta';
              resultClass = 'bg-danger';
            }
            
            const matchItem = document.createElement("div");
            matchItem.className = "list-group-item d-flex justify-content-between align-items-center";
            
            let dateDisplay = formatDate(match.date);
            
            matchItem.innerHTML = `
              <div>
                <strong>${dateDisplay}</strong> vs ${match.player2}
              </div>
              <div>
                <span class="badge ${resultClass} rounded-pill">
                  ${resultText}
                </span>
              </div>
            `;
            
            trisHistoryContainer.appendChild(matchItem);
          });
          
          // Mostra un messaggio se non ci sono partite
          if (recentPongMatches.length === 0) {
            const noMatchesItem = document.createElement("div");
            noMatchesItem.className = "list-group-item text-center text-muted";
            noMatchesItem.innerText = "Nessuna partita recente";
            pongHistoryContainer.appendChild(noMatchesItem);
          }
          
          if (recentTrisMatches.length === 0) {
            const noMatchesItem = document.createElement("div");
            noMatchesItem.className = "list-group-item text-center text-muted";
            noMatchesItem.innerText = "Nessuna partita recente";
            trisHistoryContainer.appendChild(noMatchesItem);
          }
        }
        
        // Aggiorna le statistiche quando riceviamo nuovi dati
        window.addEventListener('message', function(event) {
          console.log('Evento ricevuto:', event.data);
          if (event.data.type === 'userDataLoaded' || event.data.type === 'loadProfile' || event.data.type === 'gameResult') {
            console.log('Aggiornamento statistiche richiesto per evento:', event.data.type);
            updateStatistics();
          }
        });
      });
  </script>
  </body>
</html>