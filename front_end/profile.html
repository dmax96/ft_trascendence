<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>PONG-profile</title>
    <style>
      /* Stile base per dispositivi con schermo di larghezza inferiore a 600px */
      body {
        background-color: #dfa100;
      }
      
      /* Rimuovo la barra nera in alto */
      .navbar {
        background-color: transparent !important;
        box-shadow: none !important;
        border: none !important;
      }
      
      #hamburger {
        font-size: 24px;
        cursor: pointer;
        color: #333;
        margin: 15px;
      }

      /* Stile per dispositivi con schermo di larghezza compresa tra 600px e 900px */
      @media screen and (min-width: 600px) {
        body {
          background-color: #dfa100;
        }
        .div-title {
          font-family: "font-Despairs";
          font-size: 400%;
          position: absolute;
          left: 42%;
          right: 2%;
          top: 3%;
          padding: 1%;
          color: black;
        }
        .img-fluid {
          width:20%;
          height:20%;
          position: relative;
          top: 20%;
          left: 2%;
        }
        .image {
          width: 700px;
          height: 500px;
        }
        .nickname {
          font-family: "";
          font-size: 200%;
          position: absolute;
          top: 140%;
          left: 35%;
        }
        .statistics {
          width: 30%;
          height: 30%;
          position: absolute;
          left: 60%;
        }
      }

      /* Stile per dispositivi con schermo di larghezza superiore a 900px */
      @media screen and (min-width: 900px) {
        body {
          background-color: #dfa100;
        }
        .div-title {
          font-family: "font-Despairs";
          font-size: 400%;
          position: absolute;
          left: 42%;
          right: 2%;
          top: 3%;
          padding: 1%;
          color: black;
        }
        .profile {
          display: flex;
          position: relative;
          top: 200px;
        }
        .img-fluid {
          width: 50%;
          height: 50%;
          position: relative;
          top: 200px;
          left: 2%;
          min-height: 800px;
        }
        .image {
          width: 100%;
          height: 100%;
        }
        .nickname {
          font-family: "";
          font-size: 240%;
          position: relative;
          left: 40%;
          top: 5%;
          display: flex;
        }
        .game_title {
          font-family: "";
          font-size: 300%;
          position: relative;
          left: 42%;
          margin-bottom: 8%;
        }
        .statistics {
          height: 50%;
          width: 30%;
        }
        .data {
          font-size: 200%;
        }
        .history {
          font-size: 200%;
        }
        .pong {
          margin-bottom: 10%;
        }
        .tris {
          margin-top: 9%;
        }
        .nick {
          font-size: 143%;
          position: relative;
        }
        .modify {
          position: relative;
          left: 44%;
          cursor: pointer;
        }
        .image-container {
          position: relative;
          width: 40%; /* Adatta a seconda delle tue esigenze */
          height: 50%; /* Adatta a seconda delle tue esigenze */
          min-height: 1px;
        }

        .image-container img {
          max-width: 1000px;
          max-height: 1000px;
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .edit-icon {
          position: absolute;
          bottom: 10px;
          right: 10px;
          color: white;
          background: rgba(0, 0, 0, 0.5);
          padding: 10px;
          font-size: 24px;
          cursor: pointer;
        }
        .modal {
          display: none;
          position: fixed;
          z-index: 1;
          padding-top: 100px;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgb(0,0,0);
          background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
          background-color: #f4dc9e;
          margin: auto;
          padding: 20px;
          border: 1px solid #888;
          width: 50%;
          height: 40%;
        }

        .close {
          color: #aaaaaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
        }

        .close:hover,
        .close:focus {
          color: #000;
          text-decoration: none;
          cursor: pointer;
        }

        .image-preview img {
          width: 200px; /* Increase the width */
          height: 200px; /* Increase the height */
          margin: 5px;
          cursor: pointer; 
        }
      }

      #profilePictureOptions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      #profilePictureOptions img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: var(--transition);
      }
      
      #profilePictureOptions img:hover {
        transform: scale(1.1);
        border-color: var(--accent-color);
      }
      
      .selected-image {
        border-color: var(--highlight-color) !important;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <!-- Rimuovo l'icona hamburger -->
    </div>
    <div class="nav">
      <div class="nav-links">
        <a href="#" id="go_to_main" class="nav-link">
          <span>Home</span>
          <i class="fa-solid fa-house float-end mt-1"></i>
        </a>
        <a href="#" id="go_to_profile" class="active nav-link">
          <span>Profile</span>
          <i class="fa-solid fa-user float-end mt-1"></i>
        </a>
        <a href="#" id="go_to_login" class="nav-link">
          <span>Logout</span>
          <i class="fa-solid fa-right-from-bracket float-end mt-1"></i>
        </a>
      </div>
    </div>
    
    <div class="container mt-5 pt-5">
      <a href="#" id="title_to_main" style="text-decoration: none; cursor: pointer;">
        <h1 class="title-main text-center">Profile</h1>
      </a>
      
      <div class="row mt-5">
        <div class="col-md-5">
          <div class="card profile-card text-center">
            <div class="mb-4">
              <img id="profilePicture" class="avatar mx-auto d-block" style="width: 150px; height: 150px;" src="media/1.jpg" alt="Profile Picture">
            </div>
            <h2 id="nickname" class="mb-3">Username</h2>
            
            <div class="d-grid gap-2 mt-4">
              <button id="changePicture" class="btn btn-primary">Change Profile Picture</button>
              <button id="changePassword" class="btn btn-secondary">Change Password</button>
            </div>
          </div>
        </div>
        
        <div class="col-md-7">
          <div class="card">
            <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Statistics</h3>
            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Wins</h5>
                    <h3 id="wins" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Losses</h5>
                    <h3 id="losses" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Win Rate</h5>
                    <h3 id="winrate" class="mb-0">0%</h3>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="text-center py-3">
                    <h5>Total Games</h5>
                    <h3 id="totalGames" class="mb-0">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-4">
            <h3 class="mb-4"><i class="fas fa-history me-2"></i>Recent Games</h3>
            <div id="matchHistory" class="list-group list-group-flush">
              <!-- Match history will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Change Profile Picture Modal -->
    <div id="pictureModal" class="modal-content" style="display: none;">
      <span class="close">&times;</span>
      <h3 class="mb-3">Change Profile Picture</h3>
      <div class="row mb-3" id="profilePictureOptions">
        <!-- Profile pictures will be dynamically added here -->
      </div>
      <button id="confirmPicture" class="btn btn-primary w-100 mt-2">Confirm Selection</button>
    </div>
    
    <!-- Edit Bio Modal -->
    <div id="bioModal" class="modal-content" style="display: none;">
      <span class="close">&times;</span>
      <h3 class="mb-3">Edit Bio</h3>
      <div class="form-group">
        <textarea id="bioText" class="form-control" rows="4" placeholder="Enter your bio (max 150 characters)"></textarea>
        <button id="confirmBio" class="btn btn-primary w-100 mt-2">Save Bio</button>
      </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="passwordModal" class="modal-content" style="display: none;">
      <span class="close">&times;</span>
      <h3 class="mb-3">Change Password</h3>
      <div class="form-group">
        <label for="currentPassword">Current Password</label>
        <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
        <label for="confirmPassword">Confirm New Password</label>
        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
        <button id="confirmPassword" class="btn btn-primary w-100 mt-3">Change Password</button>
      </div>
    </div>
    
    <!-- Modal for adding friends -->
    <div id="myModal" class="modal-content rounded" style="display: none; width: 350px; padding: 25px;">
      <span class="close">&times;</span>
      <h3 class="mb-3">Add a friend</h3>
      <div style="width: 100%;">
        <input type="text" id="friendUsername" class="form-control mb-3" placeholder="Enter friend's username" style="width: 100%; display: block; margin-bottom: 15px;">
        <button id="confirmButton" class="btn btn-primary" style="width: 100%; display: block;">Confirm</button>
      </div>
    </div>
    
    <!-- Bootstrap and jQuery JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("go_to_main").addEventListener("click", function() {
          localStorage.setItem('lastPage', "main-page");
          window.parent.goToMain();
        });
        
        document.getElementById("go_to_profile").addEventListener("click", function() {
          localStorage.setItem('lastPage', "main-page");
          window.parent.goToMain();
        });
        
        document.getElementById("title_to_main").addEventListener("click", function() {
          localStorage.setItem('lastPage', "main-page");
          window.parent.goToMain();
        });
        
        document.getElementById("go_to_login").addEventListener("click", function() {
          window.parent.userInstance.resetData();
          token = localStorage.getItem('userToken');
          fetch('http://localhost:8001/login/logout/', {
            method: 'POST',
            headers: {
              'Authorization' : 'Token ' + token,
              'Content-Type': 'application/json'
            },
          }).then(response => {
            if (response.ok) {
              console.log('Logout sent successfully');
            } else {
              console.error('Error sending language change:', response.statusText);
            }
          }).catch(error => {
            console.error('Network error:', error);
          });
          localStorage.setItem('lastPage', "login");
          localStorage.setItem('userToken', '');
          window.parent.goToLogin();
        });
        
        const pictureModal = document.getElementById("pictureModal");
        const bioModal = document.getElementById("bioModal");
        const passwordModal = document.getElementById("passwordModal");
        const closeButtons = document.querySelectorAll(".close");
        
        document.getElementById("changePicture").addEventListener("click", function() {
          // Aggiungo tutte le immagini presenti nella cartella media
          const imagePaths = [
            'silvietto.jpeg', 
            'richard.jpg', 
            'mikeTyson.png', 
            'lebowski.png', 
            'carletto.jpg', 
            'blade_runner.jpeg', 
            'ai.jpg', 
            'Mattarella.jpg', 
            'Jacobs.png'
          ];
          const profilePictureOptions = document.getElementById("profilePictureOptions");
          profilePictureOptions.innerHTML = '';
          
          imagePaths.forEach(function(path) {
            const img = document.createElement('img');
            img.src = 'media/' + path;
            img.alt = path;
            img.className = 'col-3 mb-2';
            img.onclick = function() {
              document.querySelectorAll('#profilePictureOptions img').forEach(img => {
                img.classList.remove('selected-image');
              });
              this.classList.add('selected-image');
            };
            profilePictureOptions.appendChild(img);
          });
          
          pictureModal.style.display = "block";
        });
        
        document.getElementById("confirmPicture").addEventListener("click", function() {
          const selectedImage = document.querySelector('#profilePictureOptions img.selected-image');
          if (selectedImage) {
            document.getElementById('profilePicture').src = selectedImage.src;
            pictureModal.style.display = "none";
            
            const token = localStorage.getItem('userToken');
            const imagePath = selectedImage.src.replace(window.location.origin + '/', '');
            
            fetch('http://localhost:8001/main/profile_image/', {
              method: 'POST',
              headers: {
                'Authorization': 'Token ' + token,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                profile_path: imagePath
              }),
            })
            .then(response => response.json())
            .then(data => {
              console.log('Success:', data);
            })
            .catch((error) => {
              console.error('Error:', error);
            });
          }
        });
        
        document.getElementById("changePassword").addEventListener("click", function() {
          passwordModal.style.display = "block";
        });
        
        closeButtons.forEach(function(button) {
          button.addEventListener("click", function() {
            pictureModal.style.display = "none";
            bioModal.style.display = "none";
            passwordModal.style.display = "none";
          });
        });
        
        window.onclick = function(event) {
          if (event.target == pictureModal || event.target == bioModal || event.target == passwordModal) {
            pictureModal.style.display = "none";
            bioModal.style.display = "none";
            passwordModal.style.display = "none";
          }
        };
        
        if (window.parent.userInstance && window.parent.userInstance.username) {
          document.getElementById("nickname").innerText = window.parent.userInstance.player;
          document.getElementById("profilePicture").src = window.parent.userInstance.profile_image;
          
          updateStatistics();
        }
        
        function updateStatistics() {
          const wins = document.getElementById("wins");
          const losses = document.getElementById("losses");
          const winrate = document.getElementById("winrate");
          const totalGames = document.getElementById("totalGames");
          
          const totalWins = parseInt(window.parent.userInstance.wins_pong) + parseInt(window.parent.userInstance.wins_tictactoe);
          const totalLosses = parseInt(window.parent.userInstance.loses_pong) + parseInt(window.parent.userInstance.loses_tictactoe);
          const total = totalWins + totalLosses;
          const winrateValue = total > 0 ? Math.round((totalWins / total) * 100) : 0;
          
          wins.innerText = totalWins;
          losses.innerText = totalLosses;
          winrate.innerText = winrateValue + "%";
          totalGames.innerText = total;
          
          const matchHistory = document.getElementById("matchHistory");
          matchHistory.innerHTML = "";
          
          const pongHistory = window.parent.userInstance.matchistory_pong || [];
          const trisHistory = window.parent.userInstance.matchistory_tictactoe || [];
          
          const allMatches = [...pongHistory, ...trisHistory];
          allMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
          
          const recentMatches = allMatches.slice(0, 5);
          
          recentMatches.forEach(match => {
            const isWin = match.win === "true" || match.win === "win";
            const isDraw = match.win === "draw";
            
            const matchItem = document.createElement("div");
            matchItem.className = "list-group-item d-flex justify-content-between align-items-center";
            
            const gameType = match.hasOwnProperty('score') ? 'Pong' : 'Tic-Tac-Toe';
            let resultText = isWin ? 'Win' : (isDraw ? 'Draw' : 'Loss');
            
            let dateDisplay = match.date;
            if (match.date) {
              if (match.date.match(/^\d{1,2}\/\d{1,2}\/?$/)) {
                const currentYear = new Date().getFullYear();
                dateDisplay = match.date + currentYear;
              }
              
              try {
                const dateParts = dateDisplay.split('/');
                if (dateParts.length >= 3) {
                  const day = parseInt(dateParts[0], 10);
                  const month = parseInt(dateParts[1], 10) - 1;
                  const year = parseInt(dateParts[2], 10);
                  const dateObj = new Date(year, month, day);
                  if (!isNaN(dateObj.getTime())) {
                    dateDisplay = dateObj.toLocaleDateString();
                  }
                }
              } catch (e) {
                console.log("Errore nel parsing della data:", e);
              }
            }
            
            matchItem.innerHTML = `
              <div>
                <strong>${gameType}</strong> vs ${match.player2}
                <br>
                <small class="text-muted">${dateDisplay}</small>
              </div>
              <span class="badge ${isWin ? 'bg-success' : (isDraw ? 'bg-warning' : 'bg-danger')} rounded-pill">${resultText}</span>
            `;
            
            matchHistory.appendChild(matchItem);
          });
        }
        
        window.addEventListener('message', function(event) {
          if (event.data.type === 'userDataLoaded' || event.data.type === 'loadProfile') {
            document.getElementById("nickname").innerText = window.parent.userInstance.player;
            document.getElementById("profilePicture").src = window.parent.userInstance.profile_image;
            updateStatistics();
          }
        });
      });
    </script>
  </body>
</html>